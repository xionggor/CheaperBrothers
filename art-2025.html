<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>订单管理</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
  background: #f5f5f5;
}

/* ===== 登录 ===== */
#loginBox {
  max-width: 360px;
  margin: 120px auto;
  background: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,.1);
}
#loginBox h2 { margin-top: 0; }
#loginBox input {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
}
#loginBox button {
  margin-top: 14px;
  width: 100%;
  padding: 10px;
  border-radius: 20px;
  border: none;
  background: #007bff;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
}

/* ===== 主应用 ===== */
#app { display: none; }

.container { max-width: 600px; margin: 0 auto; padding: 12px; }

.post {
  position: relative;
  background: #fff;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
}
.post.refunded { filter: grayscale(1); opacity: 0.55; }

.row { display: flex; justify-content: space-between; gap: 10px; }
.info { font-size: 13px; line-height: 1.6; }

.status-tag {
  font-size: 12px;
  padding: 4px 10px;
  border-radius: 999px;
  cursor: pointer;
  white-space: nowrap;
}
.unrefunded { background: #ff4d4f; color: #fff; }
.refunded-tag { background: #d4edda; color: #155724; }

.images {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  overflow-x: auto;
}
.images img {
  width: 60px;
  height: 60px;
  border-radius: 6px;
  object-fit: cover;
  cursor: pointer;
}

.edit-btn {
  position: absolute;
  right: 12px;
  bottom: 12px;
  padding: 6px 12px;
  border-radius: 6px;
  background: #6c757d;
  color: #fff;
  font-size: 13px;
  cursor: pointer;
}

.add-btn {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 26px;
  border-radius: 24px;
  background: #007bff;
  color: #fff;
  border: none;
  font-size: 15px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 50;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  z-index: 100;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

.sheet {
  width: 100%;
  max-width: 450px;
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  max-height: 90%;
  overflow-y: auto;
}

label { font-size:13px; margin-top:14px; display:block; }
input, select {
  width:100%;
  margin-top:6px;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

.submit-btn, .delete-btn {
  margin-top: 10px;
  width: 100%;
  padding: 12px;
  border-radius: 24px;
  border: none;
  font-size: 15px;
}
.submit-btn { background:#007bff; color:#fff; }
.delete-btn { background:#dc3545; color:#fff; }

.preview {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 200;
}
.preview img {
  max-width: 90%;
  max-height: 90%;
}
</style>
</head>

<body>

<!-- 登录 -->
<div id="loginBox">
  <h2>登录</h2>
  <input id="username" placeholder="用户名">
  <input id="password" type="password" placeholder="密码">
  <button onclick="login()">登录</button>
</div>

<!-- 应用 -->
<div id="app">
  <div class="container" id="list"></div>
  <button class="add-btn" onclick="openSheet()">➕ 新建订单</button>
</div>

<!-- 弹窗 -->
<div class="overlay" id="overlay" onclick="closeSheet()">
  <form class="sheet" onsubmit="submitOrder(event)" onclick="event.stopPropagation()">
    <h2 id="form-title">新建订单</h2>

    <label>订单号</label>
    <input id="orderId" required>

    <label>价格</label>
    <input id="price" type="number" required>

    <label>自费</label>
    <input id="selfPay" type="number" value="0">

    <label>评论类型</label>
    <select id="commentType">
      <option value="免评">免评</option>
      <option value="点星">点星</option>
      <option value="评论">评论</option>
    </select>

    <label>下单日期</label>
    <input id="date" type="date">

    <label id="arrivalLabel" style="display:none;">到货日期</label>
    <input id="arrivalDate" type="date" style="display:none;">

    <label>截图</label>
    <input id="images" type="file" multiple>

    <button class="submit-btn">提交</button>
    <button type="button" class="delete-btn" id="deleteBtn" onclick="deleteOrder()">删除</button>
  </form>
</div>

<!-- 预览 -->
<div class="preview" id="preview" onclick="closePreview()">
  <img id="previewImg">
</div>

<script>
/* ===== 配置 ===== */
const API = 'https://script.google.com/macros/s/AKfycbzY1Ft-JCNtW_gFBBK26tvd1BkGpTicDrh2AJfwjjqekDemdmOH2hb3Ur6kF8MErVqH/exec';

/* ===== 登录逻辑 ===== */
(function(){
  if(localStorage.getItem('token')){
    loginBox.style.display = 'none';
    app.style.display = 'block';
  }
})();

function login(){
  fetch(API,{
    method:'POST',
    body:JSON.stringify({
      action:'login',
      username:username.value,
      password:password.value
    })
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      localStorage.setItem('token',res.token);
      loginBox.style.display='none';
      app.style.display='block';
    }else{
      alert(res.error || '登录失败');
    }
  });
}

/* ===== 模板 1 原逻辑 ===== */
const list = document.getElementById('list');
const overlay = document.getElementById('overlay');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');

let orders = [];
let editingIndex = null;

function openSheet(i=null){
  editingIndex=i;
  overlay.style.display='flex';
}
function closeSheet(){ overlay.style.display='none'; }
function deleteOrder(){
  if(editingIndex!==null){
    orders.splice(editingIndex,1);
    refreshList();
    closeSheet();
  }
}
function openPreview(src){
  previewImg.src=src;
  preview.style.display='flex';
}
function closePreview(){ preview.style.display='none'; }

function submitOrder(e){
  e.preventDefault();
  const imgs=[...images.files].map(f=>URL.createObjectURL(f));
  const data={
    orderId:orderId.value,
    price:price.value,
    selfPay:selfPay.value,
    commentType:commentType.value,
    date:date.value,
    images:imgs,
    refunded:false
  };
  if(editingIndex!==null) orders[editingIndex]=data;
  else orders.unshift(data);
  refreshList();
  closeSheet();
}

function refreshList(){
  list.innerHTML='';
  orders.forEach((o,i)=>{
    const d=document.createElement('div');
    d.className='post';
    d.innerHTML=`<div>${o.orderId}</div>`;
    d.onclick=()=>openSheet(i);
    list.appendChild(d);
  });
}
</script>

</body>
</html>
