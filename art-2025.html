<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è®¢å•ç®¡ç†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
  html, body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #f5f5f5; color: #333; }
  .container { max-width: 600px; margin: 0 auto; padding: 12px; }
  
  /* ç™»å½•ç•Œé¢ */
  #authPage { padding-top: 60px; text-align: center; }
  .auth-card { background: #fff; padding: 35px 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
  
  /* é¡¶éƒ¨å¯¼èˆª */
  .header { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 10px; }
  .header h2 { margin: 0; font-size: 18px; color: #007bff; }
  .logout-link { color: #999; font-size: 13px; cursor: pointer; text-decoration: underline; }

  /* è®¢å•å¡ç‰‡ */
  .post { position: relative; background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
  .post.refunded { filter: grayscale(1); opacity: 0.5; background: #fafafa; }
  
  .info { font-size: 13px; line-height: 1.6; }
  .info-row { display: flex; gap: 15px; margin-bottom: 2px; }
  .label-text { color: #888; margin-right: 3px; }

  /* å³ä¾§çŠ¶æ€åŒº */
  .status-box { position: absolute; top: 12px; right: 12px; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .status-tag { font-size: 11px; padding: 3px 10px; border-radius: 20px; cursor: pointer; font-weight: bold; }
  .unrefunded { background: #ff4d4f; color: #fff; }
  .refunded-tag { background: #d4edda; color: #155724; }
  
  /* å€’è®¡æ—¶æ–‡å­—æ ·å¼ */
  .countdown { font-size: 10px; color: #ff9800; font-weight: bold; font-family: monospace; }
  .expired { color: #999; }
  .urgent { color: #ff4d4f; }

  .images { display: flex; gap: 6px; margin-top: 8px; overflow-x: auto; padding-bottom: 5px; }
  .images img { width: 55px; height: 55px; border-radius: 6px; object-fit: cover; flex-shrink: 0; background: #eee; border: 1px solid #f0f0f0; }
  
  .edit-btn { position: absolute; right: 12px; bottom: 10px; padding: 4px 10px; border-radius: 6px; background: #6c757d; color: #fff; font-size: 11px; cursor: pointer; }
  .add-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 40px; border-radius: 40px; background: #007bff; color: #fff; border: none; font-size: 16px; box-shadow: 0 5px 20px rgba(0,123,255,0.4); z-index: 99; }
  
  /* å¼¹çª— */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 100; justify-content: center; align-items: center; padding: 15px; }
  .sheet { width: 100%; max-width: 450px; background: #fff; border-radius: 20px; padding: 25px; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
  label { font-size: 13px; color: #888; display: block; margin-top: 15px; }
  input, select { width: 100%; margin-top: 6px; padding: 12px; border: 1px solid #eee; border-radius: 10px; box-sizing: border-box; background: #fafafa; }
  
  .submit-btn { background: #007bff; color: #fff; width: 100%; padding: 14px; border: none; border-radius: 30px; margin-top: 25px; cursor: pointer; font-weight: bold; }
  .delete-btn { background: #fff; color: #ff4d4f; width: 100%; padding: 10px; border: 1px solid #ff4d4f; border-radius: 30px; margin-top: 12px; cursor: pointer; font-size: 13px; }
  .preview-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 200; justify-content: center; align-items: center; }
  .preview-modal img { max-width: 95%; max-height: 95%; border-radius: 8px; }
</style>
</head>
<body>

<div id="authPage" class="container">
  <div class="auth-card">
    <h2 style="margin-top:0; color:#007bff;">è®¢å•ç®¡ç†ç³»ç»Ÿ</h2>
    <input type="text" id="username" placeholder="ç”¨æˆ·å">
    <input type="password" id="password" placeholder="å¯†ç ">
    <button class="submit-btn" onclick="handleAuth('login')">ç™»å½•</button>
    <button class="submit-btn" style="background:#28a745; margin-top:10px;" onclick="handleAuth('register')">æ³¨å†Œ</button>
  </div>
</div>

<div id="mainPage" style="display:none;">
  <div class="container">
    <div class="header">
      <h2>è®¢å•åˆ—è¡¨</h2>
      <span class="logout-link" onclick="logout()">é€€å‡ºç™»å½•</span>
    </div>
    <div id="list" style="padding-bottom: 100px;"></div>
  </div>
  <button class="add-btn" id="addBtn" onclick="openSheet()">â• æ–°å»ºè®¢å•</button>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()">
  <form class="sheet" onsubmit="submitOrder(event)" onclick="event.stopPropagation()">
    <h3 id="formTitle" style="margin-top:0; border-bottom:1px solid #f0f0f0; padding-bottom:10px;">è®¢å•è¯¦æƒ…</h3>
    <label>è®¢å•å·</label><input id="orderNo" required>
    <label>ä»·æ ¼ ($)</label><input id="price" type="number" step="0.01" required>
    <label>è‡ªè´¹é‡‘é¢ ($)</label><input id="selfPay" type="number" step="0.01" value="0">
    <label>è¯„è®ºç±»å‹</label>
    <select id="commentType"><option value="å…è¯„">å…è¯„</option><option value="ç‚¹æ˜Ÿ">ç‚¹æ˜Ÿ</option><option value="è¯„è®º">è¯„è®º</option></select>
    <label>ä¸‹å•æ—¥æœŸ</label><input id="orderDate" type="date">
    <label id="arrivalLabel" style="display:none;">åˆ°è´§æ—¥æœŸ</label>
    <input id="arrivalDate" type="date" style="display:none;">
    
    <label style="color:#007bff; font-weight:bold;">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</label>
    <input id="imageFiles" type="file" multiple accept="image/*" onchange="previewLocal()">
    <div id="localPreview" class="images"></div>
    
    <button class="submit-btn" type="submit" id="subBtn">ä¿å­˜è®¢å•</button>
    <button type="button" class="delete-btn" id="deleteBtn" onclick="deleteOrder()" style="display:none;">åˆ é™¤æ­¤è®¢å•</button>
  </form>
</div>

<div class="preview-modal" id="imgPreview" onclick="this.style.display='none'"><img id="fullImg"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwV2k-25S-EJelFrPOxuUyEWrr8TFEcklbwSzYdCAayIKp8aCLPXYc_7-yU00r1u1A8/exec';
let orders = [], editingIndex = null, currentUserId = localStorage.getItem('order_uid');

window.onload = () => { if(currentUserId) showMain(); };

// --- å€’è®¡æ—¶è®¡ç®—å‡½æ•° ---
function getCountdown(orderDateStr) {
  if (!orderDateStr) return "";
  const orderDate = new Date(orderDateStr);
  const expiryDate = new Date(orderDate);
  expiryDate.setDate(orderDate.getDate() + 25); // 25å¤©åè¿‡æœŸ
  
  const now = new Date();
  const diff = expiryDate - now;
  
  if (diff <= 0) return '<span class="expired">âŒ› å·²è¶…æœŸ</span>';
  
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  
  const urgentClass = days < 3 ? 'urgent' : ''; // å°‘äº3å¤©å˜çº¢
  return `<span class="${urgentClass}">âŒ› å‰©${days}å¤©${hours}æ—¶</span>`;
}

async function api(data) {
  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
  return await res.json();
}

async function handleAuth(action) {
  const u = document.getElementById('username').value, p = document.getElementById('password').value;
  if(!u || !p) return alert("è¯·å¡«å®Œè´¦å·å¯†ç ");
  const res = await api({ action, username: u, password: p });
  if(res.success) {
    if(action === 'register') alert("æ³¨å†ŒæˆåŠŸ");
    else { currentUserId = res.userId; localStorage.setItem('order_uid', currentUserId); showMain(); }
  } else alert(res.message);
}

function logout() { localStorage.removeItem('order_uid'); location.reload(); }

function showMain() {
  document.getElementById('authPage').style.display='none';
  document.getElementById('mainPage').style.display='block';
  refreshList();
}

async function refreshList() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">è½½å…¥ä¸­...</p>';
  const res = await api({ action: 'getOrders', userId: currentUserId });
  if(res.success) {
    orders = res.orders;
    listEl.innerHTML = orders.length ? '' : '<p style="text-align:center; color:#999; margin-top:50px;">æš‚æ— æ•°æ®</p>';
    orders.forEach((o, i) => renderOrder(o, i));
  }
}

function renderOrder(o, i) {
  const post = document.createElement('div');
  post.className = 'post' + (o.refundStatus ? ' refunded' : '');
  post.innerHTML = `
    <div class="info">
      <div class="info-row">
        <span><span class="label-text">å•å·:</span>${o.orderNo}</span>
        <span><span class="label-text">ç±»å‹:</span>${o.commentType}</span>
      </div>
      <div class="info-row">
        <span><span class="label-text">ä»·æ ¼:</span>$${o.price}</span>
        <span><span class="label-text">è‡ªè´¹:</span>$${o.selfPay}</span>
      </div>
      <div class="info-row">
        <span><span class="label-text">ä¸‹å•:</span>${o.orderDate}</span>
        <span><span class="label-text">åˆ°è´§:</span>${o.arrivalDate || '-'}</span>
      </div>
    </div>
    <div class="status-box">
      <div class="status-tag ${o.refundStatus ? 'refunded-tag' : 'unrefunded'}">
        ${o.refundStatus ? 'å·²é€€æ¬¾' : 'æœªé€€æ¬¾'}
      </div>
      <div class="countdown">${o.refundStatus ? '' : getCountdown(o.orderDate)}</div>
    </div>
    <div class="images">${o.imageUrl.map(src => `<img src="${src}" onclick="showFull('${src}')">`).join('')}</div>
    <div class="edit-btn" onclick="openSheet(${i})">ç¼–è¾‘</div>
  `;
  
  const tag = post.querySelector('.status-tag');
  tag.onclick = async (e) => {
    e.stopPropagation();
    o.refundStatus = !o.refundStatus;
    post.classList.toggle('refunded', o.refundStatus);
    tag.textContent = o.refundStatus ? 'å·²é€€æ¬¾' : 'æœªé€€æ¬¾';
    tag.className = `status-tag ${o.refundStatus ? 'refunded-tag' : 'unrefunded'}`;
    // å¦‚æœå˜æ›´ä¸ºå·²é€€æ¬¾ï¼Œæ¸…ç©ºå€’è®¡æ—¶æ˜¾ç¤º
    post.querySelector('.countdown').innerHTML = o.refundStatus ? '' : getCountdown(o.orderDate);
    await api({ action: 'saveOrder', userId: currentUserId, order: o });
  };
  document.getElementById('list').appendChild(post);
}

async function processImages(files) {
  const results = [];
  for (let file of files) {
    const base64 = await new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height, max = 800;
          if (w > max) { h = Math.round((h * max) / w); w = max; }
          canvas.width = w; canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', 0.6));
        };
      };
    });
    results.push(base64);
  }
  return results;
}

async function submitOrder(e) {
  e.preventDefault();
  const btn = document.getElementById('subBtn');
  btn.disabled = true; btn.textContent = "å¤„ç†ä¸­...";
  const files = document.getElementById('imageFiles').files;
  let imgData = [];
  if(files.length > 0) imgData = await processImages(files);
  else if(editingIndex !== null) imgData = orders[editingIndex].imageUrl;

  const data = {
    orderId: editingIndex !== null ? orders[editingIndex].orderId : null,
    orderNo: document.getElementById('orderNo').value,
    price: document.getElementById('price').value,
    selfPay: document.getElementById('selfPay').value,
    commentType: document.getElementById('commentType').value,
    orderDate: document.getElementById('orderDate').value,
    arrivalDate: document.getElementById('arrivalDate').value,
    refundStatus: editingIndex !== null ? orders[editingIndex].refundStatus : false,
    imageUrl: imgData
  };

  const res = await api({ action: 'saveOrder', userId: currentUserId, order: data });
  if(res.success) { closeSheet(); refreshList(); }
  btn.disabled = false; btn.textContent = "ä¿å­˜è®¢å•";
}

function openSheet(idx = null) {
  editingIndex = idx;
  document.getElementById('overlay').style.display='flex';
  document.getElementById('localPreview').innerHTML='';
  if(idx !== null) {
    const o = orders[idx];
    document.getElementById('formTitle').textContent='ç¼–è¾‘è®¢å•';
    document.getElementById('orderNo').value=o.orderNo;
    document.getElementById('price').value=o.price;
    document.getElementById('selfPay').value=o.selfPay;
    document.getElementById('commentType').value=o.commentType;
    document.getElementById('orderDate').value=o.orderDate;
    document.getElementById('arrivalDate').value=o.arrivalDate || '';
    document.getElementById('arrivalDate').style.display='block';
    document.getElementById('arrivalLabel').style.display='block';
    document.getElementById('deleteBtn').style.display='block';
  } else {
    document.getElementById('formTitle').textContent='æ–°å»ºè®¢å•';
    document.querySelector('form').reset();
    document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('arrivalDate').style.display='none';
    document.getElementById('arrivalLabel').style.display='none';
    document.getElementById('deleteBtn').style.display='none';
  }
}

function closeSheet() { document.getElementById('overlay').style.display='none'; }
function previewLocal() {
  const div = document.getElementById('localPreview'); div.innerHTML='';
  [...document.getElementById('imageFiles').files].forEach(f => {
    const img = document.createElement('img'); img.src = URL.createObjectURL(f); div.appendChild(img);
  });
}
function showFull(s) { document.getElementById('fullImg').src=s; document.getElementById('imgPreview').style.display='flex'; }
async function deleteOrder() {
  if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
  const res = await api({ action: 'deleteOrder', userId: currentUserId, orderId: orders[editingIndex].orderId });
  if(res.success) { closeSheet(); refreshList(); }
}
</script>
</body>
</html>
